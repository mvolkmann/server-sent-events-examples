import {type Context, Hono} from 'hono';
import {serveStatic} from 'hono/bun';
import {streamSSE} from 'hono/streaming';

const app = new Hono();

// Serve index.html and styles.css from the public directory.
// The default port is 3000.
app.use('/*', serveStatic({root: './public'}));

let number = -1;

app.post('/start', async (c: Context) => {
  // number = Number(c.req.query('start'));
  const formData = await c.req.formData();
  number = Number(formData.get('start'));
  console.log('server.ts /start: number =', number);
  return c.body(null);
});

app.get('/countdown', (c: Context) => {
  return streamSSE(c, async stream => {
    while (true) {
      if (number >= 0) {
        const jsx = <div>{number}</div>;
        await stream.writeSSE({
          event: 'count',
          id: String(crypto.randomUUID()),
          data: jsx.toString()
        });
        number--;
      }
      await stream.sleep(1000); // wait one second between each message
    }
  });
});

export default app;
